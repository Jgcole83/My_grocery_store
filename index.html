<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jessy's Grocery Store</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>ðŸ›’ Grocery Store</h1>

  <!-- REGISTRATION FORM -->
  <section id="registerSection">
    <h2>Register</h2>
    <form id="registerForm">
      <input type="text" id="regName" placeholder="Full Name" required />
      <input type="text" id="regAddress" placeholder="Street Address" required />
      <input type="text" id="regCity" placeholder="City" required />
      <input type="text" id="regState" placeholder="State" required />
      <input type="text" id="regZip" placeholder="Zip Code" required />
      <input type="tel" id="regPhone" placeholder="Phone Number" required />
      <input type="email" id="regEmail" placeholder="Email" required />
      <div>
        <input type="password" id="regPassword" placeholder="Password" required />
        <label for="showPassword">Show Password</label>
        <input type="checkbox" id="showPassword" />
      </div>
      <button type="submit">Register</button>
    </form>
  </section>

  <!-- LOGIN FORM -->
  <section id="loginSection">
    <h2>Login</h2>
    <form id="loginForm">
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <p><a href="#" id="forgotPasswordLink">Forgot Password?</a></p>
  </section>

  <!-- SHOPPING FORM (HIDDEN UNTIL LOGIN) -->
  <section id="shopSection" style="display: none;">
    <h2>Place Your Order</h2>
    <form id="shoppingForm">
      <input type="number" id="budget" placeholder="Budget ($)" required />
      <input type="text" id="shoppingList" placeholder="Shopping list (comma-separated)" required />
      <button type="submit">Submit Order</button>
    </form>
  </section>

  <!-- Forgot Password Popup -->
  <div id="forgotPasswordPopup" class="popup" style="display: none;">
    <h2>Forgot Password</h2>
    <form id="forgotPasswordForm">
      <input type="email" id="forgotPasswordEmail" placeholder="Enter your email" required />
      <button type="submit">Send Reset Link</button>
      <button type="button" id="closePopup">Close</button>
    </form>
  </div>

  <!-- Reset Password Popup -->
  <div id="resetPasswordPopup" class="popup" style="display: none;">
    <h2>Reset Password</h2>
    <form id="resetPasswordForm">
      <input type="password" id="newPassword" placeholder="New Password" required />
      <input type="password" id="confirmPassword" placeholder="Confirm New Password" required />
      <button type="submit">Reset Password</button>
      <button type="button" id="closeResetPopup">Close</button>
    </form>
  </div>

  <div id="result"></div>

  <script>
    let customerId = null;
    let resetToken = '';

    // Registration
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newCustomer = {
        name: document.getElementById('regName').value,
        address: document.getElementById('regAddress').value,
        city: document.getElementById('regCity').value,
        state: document.getElementById('regState').value,
        zip: document.getElementById('regZip').value,
        phone: document.getElementById('regPhone').value,
        email: document.getElementById('regEmail').value,
        password: document.getElementById('regPassword').value
      };

      const res = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newCustomer)
      });

      const data = await res.json();
      document.getElementById('result').innerText = data.message;
    });

    // Password Toggle
    document.getElementById('showPassword').addEventListener('change', (e) => {
      const passwordField = document.getElementById('regPassword');
      if (e.target.checked) {
        passwordField.type = 'text'; // Show password
      } else {
        passwordField.type = 'password'; // Hide password
      }
    });

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const credentials = {
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
      };

      const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credentials)
      });

      const data = await res.json();

      if (data.success) {
        customerId = data.customerId;
        document.getElementById('shopSection').style.display = 'block';
        document.getElementById('result').innerText = `Welcome, ${data.name}!`;
      } else {
        document.getElementById('result').innerText = data.message;
      }
    });

    // Forgot Password Link Click
    document.getElementById('forgotPasswordLink').addEventListener('click', () => {
      document.getElementById('forgotPasswordPopup').style.display = 'block';
    });

    // Close Forgot Password Popup
    document.getElementById('closePopup').addEventListener('click', () => {
      document.getElementById('forgotPasswordPopup').style.display = 'none';
    });

    // Forgot Password Form Submission
    document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('forgotPasswordEmail').value;

      const res = await fetch('/api/forgot-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      const data = await res.json();
      document.getElementById('result').innerText = data.message;
      if (data.success) {
        resetToken = data.resetToken; // Store the reset token for later
        document.getElementById('forgotPasswordPopup').style.display = 'none';
      }
    });

    // Reset Password
    document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (newPassword !== confirmPassword) {
        return document.getElementById('result').innerText = "Passwords do not match!";
      }

      const res = await fetch(`/api/reset-password/${resetToken}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword })
      });

      const data = await res.json();
      document.getElementById('result').innerText = data.message;
      if (data.success) {
        document.getElementById('resetPasswordPopup').style.display = 'none';
      }
    });

    // Close Reset Password Popup
    document.getElementById('closeResetPopup').addEventListener('click', () => {
      document.getElementById('resetPasswordPopup').style.display = 'none';
    });

    // Submit Order
    document.getElementById('shoppingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const order = {
        customerId,
        budget: parseFloat(document.getElementById('budget').value),
        shoppingList: document.getElementById('shoppingList').value
          .split(',')
          .map(item => item.trim().toLowerCase())
      };

      const res = await fetch('/api/orders', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      });

      const data = await res.json();
      document.getElementById('result').innerText = JSON.stringify(data, null, 2);
    });
  </script>
</body>
</html>
